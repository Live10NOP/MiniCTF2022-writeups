#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <string.h>
#include <unistd.h>

//global variables
char* pigFarm[5] = {NULL};
char* cowFarm[5] = {NULL};
char* sheepFarm[5] = {NULL};

//function declarations
void setup();
int newCow();
int newPig();
int newSheep();
void zzz();
int eatFood();
void sellAnimal();
void* lastWords();

//function definitions
int main() {
	setup();
	int choice = 0;
	while(420>69) {
		puts("\nWelcome to George's awesome farm management app!");
		puts("What would you like to do?: ");
		puts("1. Buy a new pig.");
		puts("2. Buy a new cow.");
		puts("3. Buy a new sheep.");
		puts("4. Sell animal.");
		puts("5. Take a break and grab some lunch.");
		puts("6. Check out for the day.");
		printf("[#] ");
		if (scanf("%d", &choice) <= 0) {
			return 1;
		}
		switch(choice) {
			case 1:
				newPig();
				break;
			case 2:
				newCow();
				break;
			case 3:
				newSheep();
				break;
			case 4:
				sellAnimal();
				break;
			case 5:
				if (eatFood()) {
					return 1;
				}
				break;
			case 6:
				zzz();
				return 0;
			default:
				puts("Invalid option.");
				return 1;
		}
	}
	return 0;
}

void setup() {
	setvbuf(stdout,(char *)0x0,2,0);
	setvbuf(stdin,(char *)0x0,2,0);
	setvbuf(stderr,(char *)0x0,2,0);
}

int newPig() {
	if (pigFarm[4] != 0) {
		puts("The farm is already full!");
		return 0;
	} else {
		for(int i=0; i<5; i++) {
			if (pigFarm[i] == 0) {
				pigFarm[i] = (char*)malloc(0x50);
				printf("Enter Name: ");
				read(0, pigFarm[i], 0x40);
				pigFarm[i][strcspn(pigFarm[i], "\n")] = '\x00';
				return 0;
			}
		}
	}
	return 0;
}

int newCow() {
	if (cowFarm[4] != 0) {
		puts("The farm is already full!");
		return 0;
	} else {
		for(int i=0; i<5; i++) {
			if (cowFarm[i] == 0) {
				cowFarm[i] = (char*)malloc(0x50);
				printf("Enter Name: ");
				read(0, cowFarm[i], 0x40);
				cowFarm[i][strcspn(cowFarm[i], "\n")] = '\x00';
				return 0;
			}
		}
	}
	return 0;
}

int newSheep() {
	if (sheepFarm[4] != 0) {
		puts("The farm is already full!");
		return 0;
	} else {
		for(int i=0; i<5; i++) {
			if (sheepFarm[i] == 0) {
				sheepFarm[i] = (char*)malloc(0x50);
				printf("Enter Name: ");
				read(0, sheepFarm[i], 0x40);
				sheepFarm[i][strcspn(sheepFarm[i], "\n")] = '\x00';
				return 0;
			}
		}
	}
	return 0;
}

int eatFood() {

	int option;

	puts("\nMenu:");
	puts("0. Caesar Salad.");
	puts("1. A5 Wagu Burger.");
	puts("2. Pork Sausage Hotdog");
	puts("3. Lamb chops with a side of potatoes.");
	printf("Your choice: ");

	if (scanf("%d", &option) <= 0) {
		puts("An error occured.");
		return 1;
	}

	switch(option) {
		case 1:
			if (cowFarm[0] == 0) {
				puts("Sorry, we're out of Wagu.");
				break;
			}
			for(int i=4; i>=0; i--) {
				if(cowFarm[i] != 0) {
					puts("Enjoy your meal!");
					printf("Wait a sec......has anyone seen %s around lately?\n", cowFarm[i]);
					free(cowFarm[i]);
					cowFarm[i] = 0;
					break;
				}
			}
			break;
		case 2:
			if (pigFarm[0] == 0) {
				puts("Sorry, we're out of Pork.");
				break;
			}
			for(int i=4; i>=0; i--) {
				if(pigFarm[i] != 0) {
					puts("Enjoy your meal!");
					printf("Wait a sec......has anyone seen %s around lately?\n", pigFarm[i]);
					free(pigFarm[i]);
					pigFarm[i] = 0;
					break;
				}
			}
			break;
		case 3:
		if (sheepFarm[0] == 0) {
				puts("Sorry, we're out of Lamb.");
				break;
			}
			for(int i=4; i>=0; i--) {
				if(sheepFarm[i] != 0) {
					puts("Enjoy your meal!");
					printf("Wait a sec......has anyone seen %s around lately?\n", sheepFarm[i]);
					free(sheepFarm[i]);
					sheepFarm[i] = 0;
					break;
				}
			}
			break;
		case 0:
			puts("Enjoy your salad!");
			break;
		default:
			puts("Invalid option.");
			return 1;

	}	

	return 0;

}

void zzz() {	
	pthread_t t;
	puts("Any last words to George before leaving?");
	pthread_create(&t, NULL, lastWords, NULL);
	pthread_join(t, NULL);
}

void sellAnimal() {
	puts("\nNo, only George can do that.");
}

void* lastWords() {
	char msg[0x10];
	read(0, msg, 0x1000);
	return NULL;
}
